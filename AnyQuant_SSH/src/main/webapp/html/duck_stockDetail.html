<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>股票详情</title>
    <link rel="stylesheet" type="text/css" href="/css/window.css">
    <!--button-->
    <link rel="stylesheet" type="text/css" href="/css/buttons.css">
    <!-- jQuery -->
    <script src="http://cdn.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
    <!-- highcharts -->
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="/js/echarts.min.js"></script>
    <!--for evaluation chart-->
    <script src="https://code.highcharts.com/highcharts-more.js"></script>
    <script src="https://code.highcharts.com/modules/solid-gauge.js"></script>

    <link rel="stylesheet" type="text/css" href="/css/navigator.css">
    <link rel="stylesheet" href="/css/duck_stock_detail.css" type="text/css">
    <!-- <h1 class="title1">hello this is a test page!</h1> -->
    <!--tab上的小图标-->
    <link rel="shortcut icon" href="/image/short_cut.png">
</head>
<body>
<!-- navigator begin -->
<div id="nav_bar">
    <img src="/image/duck_icon_pink.png" style="width: 73px;height: 35px;float: left;margin-top:7px;margin-left: 10px">
    <!--<div style="font-size: 30px;float: left;color: #ffffff;margin-left: 10px;margin-top: 7px; ">DUCK</div>-->
    <ul id="nav_box">
        <li class="nav_item"><a class="nav_c" href="duck_main.html">股票列表</a></li>
        <li class="nav_item"><a class="nav_c" href="BoardList.html">行业分布</a></li>
        <li class="nav_item"><a class="nav_c" href="duck_optional.html">自选股</a></li>
        <li class="nav_item"><a class="nav_c" href="Analyse_input.html">回测系统</a></li>
    </ul>
</div>
<div id="blank"></div>
<!-- navigator end -->
<!--承载所有股票信息内容元素,控制两侧缩进-->
<div class="main_content">
    <div id="main_title">
        <div id="title_name"></div>
        <div id="title_code"></div>
        <div id="title_open"></div>
        <button id="add_stock_btn" class="button button-rounded button-tiny">加入自选股</button>
    </div>

    <div class="duck_window" id="chart_stock_OHLC_window">
        <div class="duck_title">
            <div class="duck_title_text">k线图</div>
        </div>
        <div class="duck_content">
            <div id="chart1"></div>
        </div>
    </div>

    <div id="relation_and_info">
        <div class="duck_window" id="relationship_window">
            <div class="duck_title">
                <div class="duck_title_text">关系图</div>
            </div>
            <div class="duck_content">
                <div id="chart2" style="width: 100%;height: 300px;"></div>
            </div>
        </div>

        <div class="duck_window" id="stockinfo_window">
            <div class="duck_title">
                <div class="duck_title_text">股票信息</div>
            </div>
            <div class="duck_content">
                <div id="stock_info_name"></div>
                <div id="stock_info_listDate"></div>
                <div id="stock_info_totalShares"></div>
                <div id="stock_info_region"></div>
                <div id="stock_info_primeOperating"></div>

            </div>
        </div>

    </div>
    <div class="duck_window" id="stockfactor_window">
        <div class="duck_title">
            <div class="duck_title_text">股票因子走势图</div>
        </div>
        <div class="duck_content">
            <div id="factor_chart"></div>
        </div>
    </div>

    <div id="score_and_radar">
        <div class="duck_window" id="score_window">
            <div class="duck_title">
                <div class="duck_title_text">综合评分</div>
            </div>
            <div class="duck_content">
                <div id="score_chart" style="height: 300px;"></div>
                <div id="comment_suggestion"></div>
                <div id="comment_analysis"></div>
            </div>
        </div>

        <div class="duck_window" id="radar_window">
            <div class="duck_title">
                <div class="duck_title_text">各项评分</div>
            </div>
            <div class="duck_content">
                <div id="radar_chart" style="width: 100%;height: 400px"></div>
            </div>
        </div>
    </div>

    <div class="duck_window" id="news_window">
        <div class="duck_title">
            <div class="duck_title_text">相关新闻</div>
        </div>
        <div class="duck_content" style="overflow-y: scroll;height: 370px" id="news_content">


        </div>

    </div>

</div>

</body>
<!-- script -->
<script>
    var myRed="#FF0000";
    var myGreen="#00CD66";
    var myName;
    function init_info() {
//        handle_login_statu();
        var code = getCode();
        var url = "/StockDetail/description/?code=" + getCode();

        $.getJSON(url, function (data) {
            document.getElementById('title_name').innerHTML = data.name;
            myName=data.name;
            document.title="Duck "+myName;
            document.getElementById('title_code').innerHTML = data.code;
//            document.getElementById('title_open').innerHTML = data.open;

            var company_name = "公司名称: "+data.name;
            var listDate = "上市日期: "+data.listDate;
            var region = "所属地区: "+data.officeAddr;
            var primeOperating = "主营业务: "+data.primeOperating;
            var totalShare = "发行量: "+(data.totalShares/10000)+" 万股";
            document.getElementById('stock_info_name').innerHTML = company_name;
            document.getElementById('stock_info_listDate').innerHTML = listDate;
            document.getElementById('stock_info_region').innerHTML = region;
            document.getElementById('stock_info_totalShares').innerHTML = totalShare;
            document.getElementById('stock_info_primeOperating').innerHTML = primeOperating;

        }, function () {
            alert("fail");
        });
        //确认该股票是否存在自选股中,以确定添加按钮的内容
        $.ajax({
            type:'post',
            url:"/Optional/check",
            data:{code:getCode()},
            success:function (data){
                if(data == true){
//                    document.getElementById('add_stock_btn').innerHTML = "删除自选股";
//                    document.getElementById('add_stock_btn').style.backgroundColor = "#990000";
//                    document.getElementById('add_stock_btn').setAttribute("statu","delete");
                    set_delete_button();
                }else if(data==false){
//                    document.getElementById('add_stock_btn').innerHTML = "加入自选股";
//                    document.getElementById('add_stock_btn').style.backgroundColor = "#00CC99";
//                    document.getElementById('add_stock_btn').setAttribute("statu","add");
                    set_add_button();
                }else{
                    alert("自选股存在性验证出错")
                }
            },
            error:function () {
                alert("请求失败");
            }
        });
        document.getElementById('add_stock_btn').addEventListener('click',function () {
//            alert("clicked!");
           if(document.getElementById('add_stock_btn').getAttribute('statu')=='add'){
//               alert("adddddd");
               $.ajax({
                   type:'post',
                   url :'/Optional/add',
                   data:{code:getCode()},
                   success:function () {
//                       document.getElementById('add_stock_btn').innerHTML = "删除自选股";
//                       document.getElementById('add_stock_btn').style.backgroundColor = "#990000";
//                       document.getElementById('add_stock_btn').setAttribute("statu","delete");
                       set_delete_button();
                   }
               });
           }else if(document.getElementById('add_stock_btn').getAttribute('statu')=='delete'){
//               alert("deletee");
               $.ajax({
                   type:'post',
                   url :'/Optional/del',
                   data:{code:getCode()},
                   success:function () {
//                       document.getElementById('add_stock_btn').innerHTML = "加入自选股";
//                       document.getElementById('add_stock_btn').style.backgroundColor = "#00CC99";
//                       document.getElementById('add_stock_btn').setAttribute("statu","add");
                       set_add_button();
                   }
               });
           }else{
               alert("删除按钮状态错误");
           }
        });
    }
    window.onload = init_info;
    function set_add_button() {
        document.getElementById('add_stock_btn').innerHTML = "加入自选股";
        document.getElementById('add_stock_btn').style.backgroundColor = "#00CC99";
        document.getElementById('add_stock_btn').setAttribute("statu","add");
    }
    function set_delete_button() {
        document.getElementById('add_stock_btn').innerHTML = "删除自选股";
        document.getElementById('add_stock_btn').style.backgroundColor = "#990000";
        document.getElementById('add_stock_btn').setAttribute("statu","delete");
    }
    function handle_login_statu() {
//        var user = '<%=session.getAttribute("user")%>';
//        if(user==null){
//            alert("no user online");
//        }else{
//            alert("user: "+user);
//        }
    }
</script>
<script type="text/javascript">
    function getParam(paras) {
        var url = location.href;
        var paraString = url.substring(url.indexOf("?")+1,url.length).split("&");
        var paraObj = {};
        for (i=0; j=paraString[i]; i++){
            paraObj[j.substring(0,j.indexOf("=")).toLowerCase()] = j.substring(j.indexOf("=")+1,j.length);
        }
        var returnValue = paraObj[paras.toLowerCase()];
        if(typeof(returnValue)=="undefined"){
            return "";
        }else{
            return returnValue;
        }
    }
</script>
<!-- get OHLC chart -->
<script type="text/javascript">

    function getCode() {
        var result = window.location.search;
        result = result.split('?')[1].split('=')[1];
        return result;
    }
    initOHLC_Chart(getCode());
    //    alert(getCode());
    function initOHLC_Chart(code) {
        $.getJSON('/Stock/getStockDataListByTime/?code='+code+'&start=2013-01-01&end=2015-01-30', function (data) {
            // split the data set into ohlc and volume
            var ohlc = [],
                    volume = [],
                    dataLength = data.length,
            // set the allowed units for data grouping
                    groupingUnits = [[
                        'week',                         // unit name
                        [1]                             // allowed multiples
                    ], [
                        'month',
                        [1, 2, 3, 4, 6]
                    ]],

                    i = 0;

            for (i; i < dataLength; i += 1) {
                ohlc.push([
                    new Date(data[i].date).getTime(),
                    data[i].open,
                    data[i].high,
                    data[i].low,
                    data[i].close
                ]);

                volume.push([
                    new Date(data[i].date).getTime(),
                    data[i].turnoverVol
                ]);
            }


            // create the chart
            $('#chart1').highcharts('StockChart', {
                plotOptions: {
                    candlestick: {
                        color: myGreen,
                        upColor: myRed
                    }
                },
                tooltip: {

                    xDateFormat:'%Y-%m-%d'

                },
                rangeSelector: {
                    selected: 0
                },

                title: {
                    text: 'k线图'
                },
                xAxis:{
                    crosshair: {color:myRed},
                },
                yAxis: [{
                    crosshair:{color:myRed},
                    labels: {
                         step:1,
                         align: 'right',
                         x: -3
                     },
                     title: {
                         text: 'k线图'
                     },
                    height: '60%',
                    lineWidth: 2
                    }, {
                        labels: {
                            align: 'right',
                            x: -3
                        },
                        title: {
                            text: '成交量'
                        },
                        top: '65%',
                        height: '35%',
                        offset: 0,
                        lineWidth: 2
                }],

                    series: [{
                        type: 'candlestick',
                        name: 'K线',
                        data: ohlc,
                        dataGrouping: {
                            units: groupingUnits
                        }
                    }, {
                        type: 'column',
                        name: '成交量',
                        data: volume,
                        yAxis: 1,
                        dataGrouping: {
                            units: groupingUnits
                        }
                    }]
                });
        });
    };
</script>
<!-- relationship chart -->
<script type="text/javascript">
    // 基于准备好的dom，初始化echarts实例
    var myChart = echarts.init(document.getElementById('chart2'));

    // 指定图表的配置项和数据
    var option = {
        title: {
            text: 'ECharts 入门示例'
        },
        tooltip: {},
        legend: {
            data:['销量']
        },
        xAxis: {
            data: ["衬衫","羊毛衫","雪纺衫","裤子","高跟鞋","袜子"]
        },
        yAxis: {},
        series: [{
            name: '销量',
            type: 'bar',
            data: [5, 20, 36, 10, 10, 20]
        }]
    };

    // 使用刚指定的配置项和数据显示图表。

    myChart.setOption(option);
</script>

<script type="text/javascript">
    $(function () {

        $.getJSON('https://www.highcharts.com/samples/data/jsonp.php?filename=aapl-c.json&callback=?', function (data) {
            // Create the chart
            $('#factor_chart').highcharts('StockChart', {


                rangeSelector : {
                    selected : 1
                },

                title : {
                    text : 'STOCK FACTOR'
                },
                yAxis:{
                    crosshair:{//color:myRed
                         },
                },

                series : [{
                    name : 'factor name',
                    data : data,
                    tooltip: {
                        valueDecimals: 2
                    }
                }]
            });
        });

    });
</script>
<script type="text/javascript">
    $.ajax({
        type:'post',
        url:'/StockDetail/evaluation',
        data:{code:getCode()},
        success:function (data) {
            init_score_chart(data.mark);
            document.getElementById('comment_suggestion').textContent=data.suggestion;
            document.getElementById('comment_analysis').textContent = data.analysis;
        }
    });
    function init_score_chart(grade) {
        var data = [];
        data.push(grade);
        var gaugeOptions = {

            chart: {
                type: 'solidgauge'
            },

            title: null,

            pane: {
                center: ['50%', '85%'],
                size: '140%',
                startAngle: -90,
                endAngle: 90,
                background: {

                    innerRadius: '60%',
                    outerRadius: '100%',
                    shape: 'arc'
                }
            },

            tooltip: {
                enabled: false
            },

            // the value axis
            yAxis: {
                stops: [
                    [0.1, '#55BF3B'], // green
                    [0.5, '#DDDF0D'], // yellow
                    [0.9, '#DF5353'] // red
                ],
                lineWidth: 0,
                minorTickInterval: null,
                tickPixelInterval: 400,
                tickWidth: 0,
                title: {
                    y: -70
                },
                labels: {
                    y: 16
                }
            },

            plotOptions: {
                solidgauge: {
                    dataLabels: {
                        y: 5,
                        borderWidth: 0,
                        useHTML: true
                    }
                }
            }
        };

        $('#score_chart').highcharts(Highcharts.merge(gaugeOptions, {
            yAxis: {
                min: 0,
                max: 100,
                title: {
                    text: 'Evaluation'
                }
            },

            credits: {
                enabled: false
            },

            series: [{
                name: 'mark',
                data: data,
                dataLabels: {
                    format: '<div style="text-align:center"><span style="font-size:25px;color:' +
                    ((Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black') + '">{y}</span><br/>' +
                    '<span style="font-size:12px;color:silver">mark</span></div>'
                },
            }]

        }));
    }
</script>
<!-- radar chart -->
<script type="text/javascript">
    $.ajax({
        type:'get',
        data:{code:getCode(),timeLen:30},
        url:'/StockDetail/getMostUsefulFactors',
        success:function (data) {
            var result = [];
//            alert("init data");
            for(var i=data.length;i>data.length-6;i++) {
                resultpush([name:data[0].name,])

            }
//            alert("data complete");
            init_radar(result);
        }
    });
    function init_radar(data) {
    alert(data);
        $('#radar_chart').highcharts({

            chart: {
                polar: true,
                type: 'line'
            },

            title: {
                text: 'Budget vs spending',
                x: -80
            },

            pane: {
                size: '80%'
            },

            xAxis: {
                categories: ['5日均线', '120日均线', '5日换手率', '120日换手率',
                    '市盈率', '市净率', '分析师推荐评级'],
                tickmarkPlacement: 'on',
                lineWidth: 0
            },

            yAxis: {
                gridLineInterpolation: 'polygon',
                lineWidth: 0,
                min: 0
            },

            tooltip: {
                shared: true,
                pointFormat: '<span style="color:{series.color}">{series.name}: <b>${point.y}</b><br/>'
            },

            legend: {
                align: 'right',
                verticalAlign: 'top',
                y: 70,
                layout: 'vertical'
            },

            series: [{
                name:"因子值",
                data:data
            }]

        });
    }
</script>
<script>
    $.ajax({
       type:'post',
       url :'/StockDetail/news',
       data:{code:getCode()},
       success:function (data) {
           var len = data.length;
//           alert(data[0].summary);
           for(var i=0;i<len;i++){
                load_news(data[i].title,data[i].publishDate,data[i].summary);
           }
       }
    });
    function load_news(title,date,summary){

        var board = document.getElementById('news_content');
        var item_bar = document.createElement("div");
        item_bar.style.width = "90%";
        item_bar.style.marginRight = "auto";
        item_bar.style.marginLeft = "auto";
        item_bar.style.marginTop = "20px";
//        item_bar.style.backgroundColor="#CCCCCC";
        var title_div = document.createElement("div");
        title_div.appendChild(document.createTextNode("标题: "+title));
        title_div.style.fontSize="25px";
        var date_div = document.createElement("div");
        date_div.appendChild(document.createTextNode("日期: "+date));
        var summary_div = document.createElement("div");
        summary_div.appendChild(document.createTextNode("内容："+summary));

        item_bar.appendChild(title_div);
        item_bar.appendChild(date_div);
        item_bar.appendChild(summary_div);
        board.appendChild(item_bar);
    }

</script>


</html>