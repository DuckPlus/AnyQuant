<html>
<head>
    <title>板块详情</title>

    <meta charset="UTF-8">
    <script type="text/javascript" src="http://cdn.hcharts.cn/jquery/jquery-1.8.3.min.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/buttons.css">
    <link rel="stylesheet" type="text/css" href="/css/flat-ui.css">
    <!--导航栏的css-->
    <link rel="stylesheet" type="text/css" href="/css/navigator.css">

    <link rel="stylesheet" type="text/css" href="/css/BoardDetail.css">
    <link rel="shortcut icon" href="/image/short_cut.png">

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/treemap.js"></script>

</head>
<style>
    .green{

        color:#00CD00;
    }
    .red{

        color:#FF0000;
    }
</style>
<body>
<div id="nav_bar">
    <img src="/image/duck_icon.png" style="width: 35px;height: 35px;float: left;margin-top:7px;margin-left: 10px">
    <div style="font-size: 30px;float: left;color: #ffffff;margin-left: 10px;margin-top: 7px; ">DUCK</div>
    <ul id="nav_box">
        <li class="nav_item"><a class="nav_c" href="duck_main.html">股票列表</a></li>
        <li class="nav_item"><a class="nav_c" href="BoardList.html">行业分布</a></li>
        <li class="nav_item"><a class="nav_c" href="duck_optional.html">自选股</a></li>
        <li class="nav_item"><a class="nav_c" href="Analyse.html">回测系统</a></li>
    </ul>
</div>
<br><br>
<span id=stockName style="position:relative;left:30px;font-size:30px"></span>
<span style="position:relative;left:60px;">今日板块涨幅：</span>
<span id=rate style="position:relative;left:60px;"></span>
<span style="position:relative;left:100px;">涨跌个数：</span>
<span id=upNum class="red" style="position:relative;left:108px;"></span>
<span style="position:relative;left:115px">/</span>
<span id=downNum class="green" style="position:relative;left:120px;"></span>
<input id="searchCode" type="text" class="form-control"  placeholder="输入板块名称" style="position:relative;left:500px;">
<button id="searchbtn" class="button button-raised button-primary button-pill" onclick="dosearch()"  style="position:relative;left:520px;">
    查询
</button>

<div id="linechart" class="linechart"><h2 class="wait"><br>加载需要时间请耐心等待哦~  ^o^</h2></div>
<div id="treechart" class="treechart"></div>



<script>
    function getCode() {
        var result = window.location.search;
        result = result.split('?')[1].split('=')[1];
        return result;
    }
    var myRed="#EE2C2C",myGreen="#00CD66",myGrey="#8B7E66"
    var myBoardName="汽车零部件";//板块的名称
    function dosearch() {
        alert(document.getElementById("searchCode").value);
    }
    function initTree(data){
        var myData=[],length=data.length;
        for(var i=0;i<5;i++){
            var tt=i+'';
            myData[i]=({
                id: tt,
                name: ' ',
                color: "#EC2500"

            });
        }
        for(var j=5;j<length+5;j++){
            var par=j%5+'';
            if(data[j-5].changeRate>0){
                myData[j]= ({
                    parent: par,
                    code: data[j-5].code,
                    name: data[j-5].stockName,
                    price:((data[j-5].open+data[j-5].close)/2).toFixed(2),
                    value:data[j-5].turnoverVol,
                    rate:data[j-5].changeRate,
                    volume:(data[j-5].turnoverVol/10000).toFixed(2),
                    color:myRed
                });
            }else if(data[j-5].changeRate<0){
                myData[j]= ({
                    parent: par,
                    code: data[j-5].code,
                    name: data[j-5].stockName,
                    price:((data[j-5].open+data[j-5].close)/2).toFixed(2),
                    value:data[j-5].turnoverVol,
                    rate:data[j-5].changeRate,
                    volume:(data[j-5].turnoverVol/10000).toFixed(2),
                    color:myGreen
                });
            }else{
                myData[j]= ({
                    parent: par,
                    code: data[j-5].code,
                    name: data[j-5].stockName,
                    price:((data[j-5].open+data[j-5].close)/2).toFixed(2),
                    value:data[j-5].turnoverVol,
                    rate:data[j-5].changeRate,
                    volume:(data[j-5].turnoverVol/10000).toFixed(2),
                    color:myGrey
                });
            }

            if(myData[j].value==0) myData[j].value=100000;

        }

        $('#treechart').highcharts({
            plotOptions: {
                series: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function () {
                                location.href="duck_stockDetail.html"+"?code="+this.code;
                            }
                        }
                    }
                }
            },
            tooltip: {
                pointFormat:'<b>{point.name}  </b>{point.code}<br>市值：<b>{point.price}</b><br/>涨跌幅：<b>{point.rate}</b>' +
                '<br/>成交量：<b>{point.volume}万</b>',
                //valueDecimals: 2
            },

            series: [{
                type: "treemap",
               // layoutAlgorithm: 'squarified',
                alternateStartingDirection: false,
                levels: [{
                    level: 1,
                    layoutAlgorithm: 'sliceAndDice',
                    dataLabels: {
                        enabled: true,
                        align: 'center',
                        //verticalAlign: 'center',
                        style: {
                            fontSize: '15px',
                            fontWeight: 'bold'
                        }
                    }
                }],
                data: myData
            }],
            title: {
                text: '成分股'
            }
        });
    }
    function initNumbers(data){
        var stockNum=data.length;
        var upNum=0,downNum=0;
        for(var i=0;i<stockNum;i++){
            if(data[i].close>=data[i].open){//涨
                upNum++;
            }
        }
        downNum=stockNum-upNum;
        var rate=0.5;//TODO 板块的涨跌幅怎么算


        if(rate>=0){
            document.getElementById('rate').style.color=myRed;
            document.getElementById('rate').innerHTML="+"+rate;
        }
        else {
            document.getElementById('rate').innerHTML=rate;
            document.getElementById('rate').style.color=myGreen;
        }

        document.getElementById('upNum').innerHTML="+"+upNum;
        document.getElementById('downNum').innerHTML="-"+downNum;
    }
    function initLine(data){
        var boardData=[],benchData=[],length=data.length;

        for(var i=0;i<length;i++){
            var date=data[i].date;
            boardData[i]=[
                new Date(date.year,date.month-1,date.day+1).getTime(),
                data[i].boardData
            ];

            benchData[i]=[
                new Date(date.year,date.month-1,date.day+1).getTime(),
                data[i].huShen300Data
            ];
        }
        $('#linechart').highcharts('StockChart', {
            legend: {
                enabled: true,
                shadow: true
            },
            tooltip:{
                xDateFormat:'%Y-%m-%d'
            },
            rangeSelector: {
                selected: 0
            },
            title: {
                text: '与大盘走势比较'
            },
            series: [
                {
                    name: myBoardName,
                    data: boardData,
                    type: 'spline',
                    tooltip: {
                        valueDecimals: 2
                    }
                },
                {
                    name: '沪深300',
                    data: benchData,
                    type: 'spline',
                    tooltip: {
                        valueDecimals: 2
                    }
                }
            ]
        });


    }
    $(document).ready(function () {
        myBoardName=getCode();
        alert(myBoardName);
        document.getElementById('stockName').innerHTML=myBoardName;
        $.getJSON('/Board/getBoardDistribution?boardName='+myBoardName, function (data) {//TODO 这里要加上板块名字
            initNumbers(data);
            initTree(data);

        });
        $.getJSON('/Board/getCompareData?boardName='+myBoardName, function (data) {

            initLine(data);
        });

    });

</script>



</body>
</html>